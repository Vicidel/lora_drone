<!--
    File: gmaps_lora_drone.html
    Author: Victor Delafontaine
    Date: May 2019
    
    Google Maps API code to create the GUI for the drone.
    Receives information from the Swisscom server app.
-->

<!DOCTYPE html>
<meta charset="utf-8"/>
<html>
    <head>
        <title>LoRa drone GUI</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <meta charset="utf-8">
        <style>
            .button {
                border-radius: 5px;
                padding: 5px;
                border: 1px solid #000;
                color: #000;
                text-decoration: none;
            }
            #map {
                height: 90%;
                width: 100%;
            }
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #legend {
                font-family: Arial, sans-serif;
                background: #fafafa;
                padding: 10px;
                margin: 10px;
                border: 2px solid #555;
            }
            #legend h3 {
                margin-top: 0;
            }
            #legend img {
                vertical-align: middle;
            }
        </style>
        <form action="#">
            <div>
                <b>Network estimate:</b>
                <button class="button" id="network_place" type="submit" onclick="network_button_cb(this, 'place')">Place on map</button>
                <button class="button" id="network_get" type="submit" onclick="network_button_cb(this, 'get')">Get from LoRa (based on last messages)</button>
                <button class="button" id="network_none" type="submit" onclick="network_button_cb(this, 'none')">Disable change (for during drone flight)</button>
            </div>
            <div>
                <b>Takeoff buttons:</b>
                <button class="button" id="R" type="submit" onclick="takeoff_button_cb(this, 'R')">Drone 1/R</button>
                <button class="button" id="G" type="submit" onclick="takeoff_button_cb(this, 'G')">Drone 2/G</button>
                <button class="button" id="B" type="submit" onclick="takeoff_button_cb(this, 'B')">Drone 3/B</button>
                <button class="button" id="X" type="submit" onclick="takeoff_button_cb(this, 'X')">None</button>
            </div>
            <div>
                <b>Common kill switch:</b>
                <button class="button" id="kill" type="submit" onclick="kill_button_cb(this, 1)">Kill</button>
                <button class="button" id="unkill" type="submit" onclick="kill_button_cb(this, 0)">Unkill</button>
            </div>
            <div class="states"></div>
        </form> 
    </head>
    <body>
        <div id="map"></div>
        <div id="legend"><h3>Legend</h3></div>

        <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>    
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script>
            // Firebase reference
            var firebase = new Firebase('https://drone-3bd2a.firebaseio.com/');

            // data object
            var data = {
                sender: null,
                timestamp: null,
                lat: null,
                lng: null
            };

            // create base coordinates
            var lat_zurich = 47.39784;
            var lng_zurich = 8.54558;
            var lat_lausanne = 46.5165372;
            var lng_lausanne = 6.5628348;

            // storage            
            var lat_homeR, lng_homeR, lat_homeG, lng_homeG, lat_homeB, lng_homeB;
            var lat_droneR, lng_droneR, lat_droneG, lng_droneG, lat_droneB, lng_droneB;

            // drones states
            var stateR = "UNKNOWN";
            var stateG = "UNKNOWN";
            var stateB = "UNKNOWN";
            change_states(stateR, stateG, stateB);

            // geofence
            var geofence_radius = 0;

            // initial button colors: call callbacks as if clicked
            takeoff_button_cb(this, 'X');
            kill_button_cb(this, 0);
            network_button_cb(this, 'none');

            // listener active for click
            click_listener_active = false

            // after click on RGB takeoff, go in none mode after X milliseconds 
            var delay_after_takeoff = 5000;


            // creates a map object
            function init_map() {

                // define the map itself
                var map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: lat_zurich, lng: lng_zurich},
                    zoom: 16,
                    styles: [{
                        featureType: 'poi',
                        stylers: [{ visibility: 'off' }]  // Turn off POI.
                    },
                    {
                        featureType: 'transit.station',
                        stylers: [{ visibility: 'off' }]  // Turn off bus, train stations...
                    }],
                    disableDoubleClickZoom: false,
                    streetViewControl: false,
                });

                // centering controls
                init_centering_controls(map);

                // things on the map
                var markers = create_markers(map);      // create marker
                var wp_lists = create_waypoint_lists(); // create waypoint lists
                var circles = create_circles();         // create circles
                var paths = create_paths(map);          // create paths

                // listener for clicks
                map.addListener('click', function(e) {
                    // check is listener is active
                    if(click_listener_active){
                        // get coordinates 
                        var lat = e.latLng.lat();
                        var lng = e.latLng.lng();

                        // post network estimate on server
                        const url='http://victor.scapp.io/lora/network_estimate_latlng';
                        const data={'lat': lat, 'lng': lng}
                        axios({method: 'POST', url: url, data: data})
                    }
                });

                // legend
                init_legend(map);

                // start Firebase and database listeners
                init_firebase_homes(map, markers);                  // homes
                init_firebase_drones(map, markers, paths);          // drones, paths
                init_firebase_waypoints(map, wp_lists);             // waypoints
                init_firebase_estimations(map, markers, circles);   // estimations
            }

            // set the states in GUI
            function change_states(stateR, stateG, stateB){
                // change the string in HTML stuff
                document.querySelector('.states').innerHTML = "<b>Last received state: </b>droneR: "+stateR+", droneG: "+stateG+", droneB: "+stateB;
            }

            // init centering controls
            function init_centering_controls(map) {

                // create div for centering button
                var centerControlDiv = document.createElement('div');
                var centerControl = new center_control(centerControlDiv, map, lat_lausanne, lng_lausanne, "Lausanne");
                centerControlDiv.index = 1;
                map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv);
      
                // create div for centering button
                var centerControlDiv2 = document.createElement('div');
                var centerControl2 = new center_control(centerControlDiv2, map, lat_zurich, lng_zurich, "Zurich");
                centerControlDiv2.index = 1;
                map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv2);

                // create div for centering button
                var centerControlDiv3 = document.createElement('div');
                var centerControl3 = new center_control(centerControlDiv3, map, 0, 0, "Zero");
                centerControlDiv3.index = 1;
                map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv3);
            }

            // creates a GUI for centering map
            function center_control(control_div, map, lat, lng, string){

                // Set CSS for the control border.
                var controlUI = document.createElement('div');
                controlUI.style.backgroundColor = '#fff';
                controlUI.style.border = '2px solid #fff';
                controlUI.style.borderRadius = '3px';
                controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
                controlUI.style.cursor = 'pointer';
                controlUI.style.marginBottom = '22px';
                controlUI.style.textAlign = 'center';
                controlUI.title = 'Click to recenter the map';
                control_div.appendChild(controlUI);

                // Set CSS for the control interior.
                var controlText = document.createElement('div');
                controlText.style.color = 'rgb(25,25,25)';
                controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
                controlText.style.fontSize = '14px';
                controlText.style.lineHeight = '20px';
                controlText.style.paddingLeft = '5px';
                controlText.style.paddingRight = '5px';
                controlText.innerHTML = string;
                controlUI.appendChild(controlText);

                // Setup the click event listeners: simply set the map to Chicago.
                controlUI.addEventListener('click', function() {
                    console.log("Centering on "+string)
                    map.setCenter(new google.maps.LatLng(lat, lng));
                    map.setZoom(16);
                });
            }

            // init legend
            function init_legend(map){
                // create legend object
                var legend = document.getElementById('legend');

                // add homeR
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/homeR.png width=20> Home 1/R'
                legend.appendChild(div);

                // add homeG
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/homeG.png width=20> Home 2/G'
                legend.appendChild(div);

                // add homeB
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/homeB.png width=20> Home 3/B'
                legend.appendChild(div);

                // add droneR
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/droneR.png width=20> Drone 1/R'
                legend.appendChild(div);

                // add droneG
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/droneG.png width=20> Drone 2/G'
                legend.appendChild(div);

                // add droneB
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/droneB.png width=20> Drone 3/B'
                legend.appendChild(div);

                // add waypoint past
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/waypointR_old_circle.png width=20> Drone 1/R past waypoint'
                legend.appendChild(div);

                // add waypoint current
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/waypointR_current_circle.png width=20> Drone 1/R current waypoint'
                legend.appendChild(div);

                // add waypoint past
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/waypointG_old_circle.png width=20> Drone 2/G past waypoint'
                legend.appendChild(div);

                // add waypoint current
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/waypointG_current_circle.png width=20> Drone 2/G current waypoint'
                legend.appendChild(div);

                // add waypoint past
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/waypointB_old_circle.png width=20> Drone 3/B past waypoint'
                legend.appendChild(div);

                // add waypoint current
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/waypointB_current_circle.png width=20> Drone 3/B current waypoint'
                legend.appendChild(div);

                // add network
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/network_circle.png width=20> Network estimate'
                legend.appendChild(div);

                // add est1
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/estimate2_circle.png width=20> First estimation'
                legend.appendChild(div);

                // add est2
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/estimate_circle.png width=20> Second estimation'
                legend.appendChild(div);

                // push on map
                map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);
            }

            // init Firebase for home
            function init_firebase_homes(map, markers) {

                // reference in Firebase
                var home_refR = firebase.child('homeR');
                var home_refG = firebase.child('homeG');
                var home_refB = firebase.child('homeB');

                // for homeR
                home_refR.on('child_added', function(snapshot){

                    // get coordinates
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // move marker
                    markers.homeR.setPosition(new google.maps.LatLng(lat, lng));
                    markers.homeR.setMap(map);

                    // move geofence circle
                    //markers.home_circle.setCenter(new google.maps.LatLng(lat, lng));
                    //markers.home_circle.setRadius(geofence_radius);
                    //markers.home_circle.setMap(map);

                    // set start as home
                    lat_homeR = lat;
                    lng_homeR = lng;
                });
                home_refR.on('child_removed', function(snapshot) {
                    markers.homeR.setMap(null)
                    //markers.home_circle.setMap(null)
                });

                // for homeG
                home_refG.on('child_added', function(snapshot){

                    // get coordinates
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // move marker
                    markers.homeG.setPosition(new google.maps.LatLng(lat, lng));
                    markers.homeG.setMap(map);

                    // move geofence circle
                    //markers.home_circle.setCenter(new google.maps.LatLng(lat, lng));
                    //markers.home_circle.setRadius(geofence_radius);
                    //markers.home_circle.setMap(map);

                    // set start as home
                    lat_homeG = lat;
                    lng_homeG = lng;
                });
                home_refG.on('child_removed', function(snapshot) {
                    markers.homeG.setMap(null)
                    //markers.home_circle.setMap(null)
                });

                // for homeB
                home_refB.on('child_added', function(snapshot){

                    // get coordinates
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // move marker
                    markers.homeB.setPosition(new google.maps.LatLng(lat, lng));
                    markers.homeB.setMap(map);

                    // move geofence circle
                    //markers.home_circle.setCenter(new google.maps.LatLng(lat, lng));
                    //markers.home_circle.setRadius(geofence_radius);
                    //markers.home_circle.setMap(map);

                    // set start as home
                    lng_homeB = lat;
                    lng_homeB = lng;
                });
                home_refB.on('child_removed', function(snapshot) {
                    markers.homeB.setMap(null)
                    //markers.home_circle.setMap(null)
                });
            }

            // init Firebase for drones and paths
            function init_firebase_drones(map, markers, paths) {

                // reference in Firebase
                var drone_refR = firebase.child('droneR');
                var drone_refG = firebase.child('droneG');
                var drone_refB = firebase.child('droneB');

                // for droneR
                drone_refR.on('child_added', function(snapshot) {

                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // move marker
                    markers.droneR.setPosition(new google.maps.LatLng(lat, lng));
                    markers.droneR.setMap(map);

                    // draw path
                    paths.listR.push({lat: lat, lng: lng});
                    paths.lineR.setPath(paths.listR);
                    paths.lineR.setMap(map)

                    // change state in HTML
                    stateR = snapshot.val().state;
                    change_states(stateR, stateG, stateB);

                    // change variable
                    lat_droneR = lat;
                    lng_droneR = lng;
                });
                drone_refR.on('child_removed', function(snapshot) {
                    markers.droneR.setMap(null)
                    paths.lineR.setMap(null)
                    paths.listR = []
                    change_states('UNKNOWN', 'UNKNOWN', 'UNKNOWN');
                });

                // for droneG
                drone_refG.on('child_added', function(snapshot) {

                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // move marker
                    markers.droneG.setPosition(new google.maps.LatLng(lat, lng));
                    markers.droneG.setMap(map);

                    // draw path
                    paths.listG.push({lat: lat, lng: lng});
                    paths.lineG.setPath(paths.listG);
                    paths.lineG.setMap(map)

                    // change state in HTML
                    stateG = snapshot.val().state;
                    change_states(stateR, stateG, stateB);

                    // change variable
                    lat_droneG = lat;
                    lng_droneG = lng;
                });
                drone_refG.on('child_removed', function(snapshot) {
                    markers.droneG.setMap(null)
                    paths.lineG.setMap(null)
                    paths.listG = []
                    change_states('UNKNOWN', 'UNKNOWN', 'UNKNOWN');
                });

                // for droneB
                drone_refB.on('child_added', function(snapshot) {

                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // move marker
                    droneB_marker.setPosition(new google.maps.LatLng(lat, lng));
                    droneB_marker.setMap(map);

                    // draw path
                    paths.listB.push({lat: lat, lng: lng});
                    paths.lineB.setPath(paths.listB);
                    paths.lineB.setMap(map)

                    // change state in HTML
                    stateB = snapshot.val().state;
                    change_states(stateR, stateG, stateB);

                    // change variable
                    lat_droneB = lat;
                    lng_droneB = lng;
                });
                drone_refB.on('child_removed', function(snapshot) {
                    markers.droneB.setMap(null)
                    paths.lineB.setMap(null)
                    paths.listB = []
                    change_states('UNKNOWN', 'UNKNOWN', 'UNKNOWN');
                });
            }

            // init Firebase for waypoints
            function init_firebase_waypoints(map, wp_lists) {

                // reference in Firebase
                var wayp_refR  = firebase.child('waypointR');
                var wayp_refG  = firebase.child('waypointG');
                var wayp_refB  = firebase.child('waypointB');

                // for waypoint R
                wayp_refR.on('child_added', function(snapshot) {
                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // change color of last waypoints
                    wp_lists.wpR.forEach(function(item, index, array){
                        item.setIcon('marker/waypointR_old.png');
                    });

                    // create new marker
                    var waypoint_marker = new google.maps.Marker({
                        position: {lat: lat, lng: lng},
                        map: map,
                        icon: 'marker/waypointR_current.png',
                        title: 'Waypoint',
                    });

                    // add it to list
                    wp_lists.wpR.push(waypoint_marker);
                });
                wayp_refR.on('child_removed', function(snapshot) {
                    wp_lists.wpR.forEach(function(item, index, array){
                        item.setMap(null)
                    });  
                });

                // for waypoint G
                wayp_refG.on('child_added', function(snapshot) {
                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // change color of last waypoints
                    wp_lists.wpG.forEach(function(item, index, array){
                        item.setIcon('marker/waypointG_old.png');
                    });

                    // create new marker
                    var waypoint_marker = new google.maps.Marker({
                        position: {lat: lat, lng: lng},
                        map: map,
                        icon: 'marker/waypointG_current.png',
                        title: 'Waypoint',
                    });

                    // add it to list
                    wp_lists.wpG.push(waypoint_marker);
                });
                wayp_refG.on('child_removed', function(snapshot) {
                    wp_lists.wpG.forEach(function(item, index, array){
                        item.setMap(null)
                    });  
                });

                // for waypoint B
                wayp_refB.on('child_added', function(snapshot) {
                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // change color of last waypoints
                    wp_lists.wpB.forEach(function(item, index, array){
                        item.setIcon('marker/waypointB_current.png');
                    });

                    // create new marker
                    var waypoint_marker = new google.maps.Marker({
                        position: {lat: lat, lng: lng},
                        map: map,
                        icon: 'marker/waypointB_old.png',
                        title: 'Waypoint',
                    });

                    // add it to list
                    wp_lists.wpB.push(waypoint_marker);
                });
                wayp_refB.on('child_removed', function(snapshot) {
                    wp_lists.wpB.forEach(function(item, index, array){
                        item.setMap(null)
                    });  
                });
            }

            // init Firebase for estimations
            function init_firebase_estimations(map, markers, circles) {

                // reference in Firebase
                var netw_ref   = firebase.child('network');
                var est_ref    = firebase.child('estimate');

                // for network points
                netw_ref.on('child_added', function(snapshot) {

                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // move marker
                    markers.network.setPosition(new google.maps.LatLng(lat, lng));
                    markers.network.setMap(map);
                });
                netw_ref.on('child_removed', function(snapshot) {
                    //markers.network.setMap(null)
                });

                // for new estimation
                est_ref.on('child_added', function(snapshot) {
                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;
                    var rad = snapshot.val().radius;

                    // different colors based on radius
                    if(rad==150) {
                        circles.c1.setCenter(new google.maps.LatLng(lat, lng));
                        circles.c1.setMap(map);
                        circles.c1.setRadius(rad);
                        markers.network.setPosition(new google.maps.LatLng(lat, lng));
                        markers.network.setMap(map);
                    }
                    if(rad==25) {
                        circles.c2.setCenter(new google.maps.LatLng(lat, lng));
                        circles.c2.setMap(map);
                        circles.c2.setRadius(rad);
                        markers.est1.setPosition(new google.maps.LatLng(lat, lng));
                        markers.est1.setMap(map);
                    }
                    if(rad==10) {
                        circles.c3.setCenter(new google.maps.LatLng(lat, lng));
                        circles.c3.setMap(map);
                        circles.c3.setRadius(rad);
                        markers.est2.setPosition(new google.maps.LatLng(lat, lng));
                        markers.est2.setMap(map);
                    }
                });
                est_ref.on('child_removed', function(snapshot) {
                    circles.c1.setMap(null);
                    circles.c2.setMap(null);
                    circles.c3.setMap(null);
                    markers.est1.setMap(null);
                    markers.est2.setMap(null);
                });
            }   

            // callback for killswitch button
            function kill_button_cb(obj, kill){
                if(kill==1){
                    console.log("Killing all drones now");
                    document.getElementById('unkill').style.backgroundColor='#fff';
                    document.getElementById('kill').style.backgroundColor='#aaa';
                }
                else{
                    console.log("Unkilling all drones now");
                    document.getElementById('unkill').style.backgroundColor='#aaa';
                    document.getElementById('kill').style.backgroundColor='#fff';
                }

                // POST on server
                const url='http://victor.scapp.io/param/drone_kill';
                const data={'kill': kill}
                axios({method: 'POST', url: url, data: data})
            }

            // callback for takeoff button
            function takeoff_button_cb(obj, drone_id) {
                //console.log("Starting drone: "+drone_id)

                // create data according to which button was pressed
                var data;
                if(drone_id=='R') {
                    // data to send 
                    data={'bool_drone1_start': 1, 'bool_drone2_start': 0, 'bool_drone3_start': 0};

                    // buttons color
                    document.getElementById('R').style.backgroundColor='#aaa';
                    document.getElementById('G').style.backgroundColor='#fff';
                    document.getElementById('B').style.backgroundColor='#fff';
                    document.getElementById('X').style.backgroundColor='#fff';

                    // go back in None after X seconds
                    console.log("Setting drone "+drone_id+" to takeoff, disabling network estimate change");
                    setTimeout(function(){console.log("Setting drone takeoff back to none ("+delay_after_takeoff/1000+" seconds passed)");takeoff_button_cb(this, 'X')}, delay_after_takeoff);

                    // disable network estimate change
                    network_button_cb(this, 'none');
                }
                if(drone_id=='G') {
                    // data to send 
                    data={'bool_drone1_start': 0, 'bool_drone2_start': 1, 'bool_drone3_start': 0};

                    // buttons color
                    document.getElementById('R').style.backgroundColor='#fff';
                    document.getElementById('G').style.backgroundColor='#aaa';
                    document.getElementById('B').style.backgroundColor='#fff';
                    document.getElementById('X').style.backgroundColor='#fff';

                    // go back in None after X seconds
                    console.log("Setting drone "+drone_id+" to takeoff, disabling network estimate change");
                    setTimeout(function(){console.log("Setting drone takeoff back to none ("+delay_after_takeoff/1000+" seconds passed)");takeoff_button_cb(this, 'X')}, delay_after_takeoff);

                    // disable network estimate change
                    network_button_cb(this, 'none');
                }
                if(drone_id=='B') {
                    // data to send 
                    data={'bool_drone1_start': 0, 'bool_drone2_start': 0, 'bool_drone3_start': 1};

                    // buttons color
                    document.getElementById('R').style.backgroundColor='#fff';
                    document.getElementById('G').style.backgroundColor='#fff';
                    document.getElementById('B').style.backgroundColor='#aaa';
                    document.getElementById('X').style.backgroundColor='#fff';

                    // go back in None after X seconds
                    console.log("Setting drone "+drone_id+" to takeoff, disabling network estimate change");
                    setTimeout(function(){console.log("Setting drone takeoff back to none ("+delay_after_takeoff/1000+" seconds passed)");takeoff_button_cb(this, 'X')}, delay_after_takeoff);

                    // disable network estimate change
                    network_button_cb(this, 'none');
                }
                if(drone_id=='X') {
                    // data to send 
                    data={'bool_drone1_start': 0, 'bool_drone2_start': 0, 'bool_drone3_start': 0};

                    // buttons color
                    document.getElementById('R').style.backgroundColor='#fff';
                    document.getElementById('G').style.backgroundColor='#fff';
                    document.getElementById('B').style.backgroundColor='#fff';
                    document.getElementById('X').style.backgroundColor='#aaa';
                }

                // POST on server
                const url='http://victor.scapp.io/param/drone_start';
                axios({method: 'POST', url: url, data: data})
            }

            // callback for network estimate button
            function network_button_cb(obj, type, map) {

                // 
                if(type=='get') {
                    // button color
                    document.getElementById('network_get').style.backgroundColor='#aaa';
                    document.getElementById('network_place').style.backgroundColor='#fff';
                    document.getElementById('network_none').style.backgroundColor='#fff';

                    // click listener
                    click_listener_active = false

                    // call function
                    get_lora_network_estimate();
                }
                if(type=='place') {
                    // button color
                    document.getElementById('network_get').style.backgroundColor='#fff';
                    document.getElementById('network_place').style.backgroundColor='#aaa';
                    document.getElementById('network_none').style.backgroundColor='#fff';

                    // click listener
                    click_listener_active = true
                }
                if(type=='none') {
                    // button color
                    document.getElementById('network_get').style.backgroundColor='#fff';
                    document.getElementById('network_place').style.backgroundColor='#fff';
                    document.getElementById('network_none').style.backgroundColor='#aaa';

                    // click listener
                    click_listener_active = false
                }
            }

            // get lora network estimate
            function get_lora_network_estimate() {

                // TODO: improve that to avoid back and forth between server and gmaps

                // get network est from server
                const url_get='http://victor.scapp.io/lora/compute_network_est';
                axios({method: 'GET', url: url_get}).then(function(response){
                    
                    // extract data
                    var lat = response.data.lat;
                    var lng = response.data.lng;

                    // post network estimate back on server
                    const url='http://victor.scapp.io/lora/network_estimate_latlng';
                    const data={'lat': lat, 'lng': lng}
                    axios({method: 'POST', url: url, data: data})
                });
            }

            // creates the custom icons
            function create_icons() {
                
                // drone icons
                var droneR_icon = {
                    url: 'marker/droneR.png',
                    anchor: new google.maps.Point(13, 13),
                    scaledSize: new google.maps.Size(25, 25)
                };
                var droneG_icon = {
                    url: 'marker/droneG.png',
                    anchor: new google.maps.Point(13, 13),
                    scaledSize: new google.maps.Size(25, 25)
                };
                var droneB_icon = {
                    url: 'marker/droneB.png',
                    anchor: new google.maps.Point(13, 13),
                    scaledSize: new google.maps.Size(25, 25)
                };

                // home icon
                var homeR_icon = {
                    url: 'marker/homeR.png',
                    anchor: new google.maps.Point(13, 13),
                    scaledSize: new google.maps.Size(25, 25)
                };
                var homeG_icon = {
                    url: 'marker/homeG.png',
                    anchor: new google.maps.Point(13, 13),
                    scaledSize: new google.maps.Size(25, 25)
                };
                var homeB_icon = {
                    url: 'marker/homeB.png',
                    anchor: new google.maps.Point(13, 13),
                    scaledSize: new google.maps.Size(25, 25)
                };

                // return them
                return {droneR: droneR_icon, droneG: droneG_icon, droneB: droneB_icon, homeR: homeR_icon, homeB: homeB_icon, homeG: homeG_icon};
            }

            // creates the markers
            function create_markers(map, icons) {

                // create custom markers icons
                var icons = create_icons();

                // for drones
                var droneR_marker = new google.maps.Marker({
                    map: map,
                    icon: icons.droneR,
                    title: 'Drone 1/R'
                });
                var droneG_marker = new google.maps.Marker({
                    map: map,
                    icon: icons.droneG,
                    title: 'Drone 2/G'
                });
                var droneB_marker = new google.maps.Marker({
                    map: map,
                    icon: icons.droneB,
                    title: 'Drone 3/B'
                });

                // for home
                var home_markerR = new google.maps.Marker({
                    map: map,
                    icon: icons.homeR,
                    title: 'Home 1/R'
                });
                var home_markerG = new google.maps.Marker({
                    map: map,
                    icon: icons.homeG,
                    title: 'Home 2/G'
                });
                var home_markerB = new google.maps.Marker({
                    map: map,
                    icon: icons.homeB,
                    title: 'Home 3/B'
                });
                var home_circle = new google.maps.Circle({
                    strokeColor: '#000000',
                    strokeOpacity: 1,
                    strokeWeight: 1,
                    fillColor: '#FFF',
                    fillOpacity: 0,
                });

                // for estimations
                var network_marker = new google.maps.Marker({
                    map: map,
                    icon: 'marker/network.png',
                    title: 'Network estimate',
                });
                var est_marker1 = new google.maps.Marker({
                    map: map,
                    icon: 'marker/estimate2.png',
                    title: 'First estimation',
                });
                var est_marker2 = new google.maps.Marker({
                    map: map,
                    icon: 'marker/estimate.png',
                    title: 'Second estimation',
                });

                // return them 
                return {droneR: droneR_marker, droneG: droneG_marker, droneB: droneB_marker, homeR: home_markerR, homeG: home_markerG, homeB: home_markerB, home_circle: home_circle, network: network_marker, est1: est_marker1, est2: est_marker2};
            }

            // creates the circles
            function create_circles() {

                var network_circle1 = new google.maps.Circle({
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.5,
                    strokeWeight: 2,
                    fillColor: '#FF0000',
                    fillOpacity: 0.1,
                })

                var network_circle2 = new google.maps.Circle({
                    strokeColor: '#FFBB00',
                    strokeOpacity: 0.5,
                    strokeWeight: 2,
                    fillColor: '#FF9900',
                    fillOpacity: 0.2,
                })

                var network_circle3 = new google.maps.Circle({
                    strokeColor: '#FFFF00',
                    strokeOpacity: 0.5,
                    strokeWeight: 2,
                    fillColor: '#FFFF00',
                    fillOpacity: 0.1,
                })

                return {c1: network_circle1, c2: network_circle2, c3: network_circle3};
            }

            // creates the waypoints lists (empty)
            function create_waypoint_lists() {

                // return empty
                return {wpR: [], wpG: [], wpB: []};
            }

            // creates the drone paths lines and the list 
            function create_paths(map) { 

                // flight path
                var flight_pathR = new google.maps.Polyline({
                    map: map,
                    geodesic: true,
                    strokeColor: '#DD0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 3
                });
                var pathR = [];

                var flight_pathG = new google.maps.Polyline({
                    map: map,
                    geodesic: true,
                    strokeColor: '#00CC00',
                    strokeOpacity: 1.0,
                    strokeWeight: 3
                });
                var pathG = [];

                var flight_pathB = new google.maps.Polyline({
                    map: map,
                    geodesic: true,
                    strokeColor: '#0000DD',
                    strokeOpacity: 1.0,
                    strokeWeight: 3
                });
                var pathB = [];

                // return
                return {listR: [], lineR: flight_pathR, listG: [], lineG: flight_pathG, listB: [], lineB: flight_pathB};
            }

        </script>
        <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxXZYRRheu8t7VGerySo98OVrOxjdcZe8&libraries=visualization&callback=init_map">
        </script>
    </body>
</html>