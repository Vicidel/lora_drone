<!DOCTYPE html>
<meta charset="utf-8"/>
<html>
    <head>
        <title>LoRa drone GUI</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <meta charset="utf-8">
        <style>
            #map {
                height: 90%;
                width: 100%;
            }
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #legend {
                font-family: Arial, sans-serif;
                background: #fafafa;
                padding: 10px;
                margin: 10px;
                border: 2px solid #555;
            }
            #legend h3 {
                margin-top: 0;
            }
            #legend img {
                vertical-align: middle;
            }
        </style>
        <form action="#">
            <div>
                <b>Drone to start for takeoff:</b>
                drone 1: <input type="checkbox" id="drone1box" onclick="checkbox_drone_cb(this,'d1')" autocomplete="off"/>
                drone 2: <input type="checkbox" id="drone2box" onclick="checkbox_drone_cb(this,'d2')" autocomplete="off"/>
                drone 3: <input type="checkbox" id="drone3box" onclick="checkbox_drone_cb(this,'d3')" autocomplete="off"/>
                <button type="submit" onclick="takeoff_button_cb(this)">Takeoff</button>
            </div>
            <div>
                <b>Kill switch:</b>
                <button type="submit" onclick="kill_button_cb(this)">Kill</button>
                <button type="submit" onclick="unkill_button_cb(this)">Unkill</button>
            </div>
        </form> 
    </head>
    <body>
        <div id="map"></div>
        <div id="legend"><h3>Legend</h3></div>

        <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>    
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script>
            // Firebase reference
            var firebase = new Firebase('https://drone-3bd2a.firebaseio.com/');

            // data object
            var data = {
                sender: null,
                timestamp: null,
                lat: null,
                lng: null
            };

            // create base coordinates
            var lat_zurich = 47.39784;
            var lng_zurich = 8.54558  
            var lat_start = lat_zurich;
            var lng_start = lng_zurich;

            // for drone start from server
            var drone1_start = 0;
            var drone2_start = 0;
            var drone3_start = 0;

            // creates a GUI for centering map
            function center_control(control_div, map){
                // Set CSS for the control border.
                var controlUI = document.createElement('div');
                controlUI.style.backgroundColor = '#fff';
                controlUI.style.border = '2px solid #fff';
                controlUI.style.borderRadius = '3px';
                controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
                controlUI.style.cursor = 'pointer';
                controlUI.style.marginBottom = '22px';
                controlUI.style.textAlign = 'center';
                controlUI.title = 'Click to recenter the map';
                control_div.appendChild(controlUI);

                // Set CSS for the control interior.
                var controlText = document.createElement('div');
                controlText.style.color = 'rgb(25,25,25)';
                controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
                controlText.style.fontSize = '14px';
                controlText.style.lineHeight = '20px';
                controlText.style.paddingLeft = '5px';
                controlText.style.paddingRight = '5px';
                controlText.innerHTML = 'Center map on Home';
                controlUI.appendChild(controlText);

                // Setup the click event listeners: simply set the map to Chicago.
                controlUI.addEventListener('click', function() {
                    map.setCenter(new google.maps.LatLng(lat_start, lng_start));
                    map.setZoom(16);
                });
            }

            // creates a GUI for centering map
            function center_control2(control_div, map){
                // Set CSS for the control border.
                var controlUI = document.createElement('div');
                controlUI.style.backgroundColor = '#fff';
                controlUI.style.border = '2px solid #fff';
                controlUI.style.borderRadius = '3px';
                controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
                controlUI.style.cursor = 'pointer';
                controlUI.style.marginBottom = '22px';
                controlUI.style.textAlign = 'center';
                controlUI.title = 'Click to recenter the map';
                control_div.appendChild(controlUI);

                // Set CSS for the control interior.
                var controlText = document.createElement('div');
                controlText.style.color = 'rgb(25,25,25)';
                controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
                controlText.style.fontSize = '14px';
                controlText.style.lineHeight = '20px';
                controlText.style.paddingLeft = '5px';
                controlText.style.paddingRight = '5px';
                controlText.innerHTML = 'Center map on Zurich';
                controlUI.appendChild(controlText);

                // Setup the click event listeners: simply set the map to Chicago.
                controlUI.addEventListener('click', function() {
                    map.setCenter(new google.maps.LatLng(lat_zurich, lng_zurich));
                    map.setZoom(16);
                });
            }

            // callback for checkboxes
            function checkbox_drone_cb(box, drone_id) {
                if(box.checked) {
                    if(drone_id=='d1') drone1_start = 1;
                    if(drone_id=='d2') drone2_start = 1;
                    if(drone_id=='d3') drone3_start = 1;
                }
                else {
                    if(drone_id=='d1') drone1_start = 0;
                    if(drone_id=='d2') drone2_start = 0;
                    if(drone_id=='d3') drone3_start = 0;
                }
            }

            // callback for killswitch button
            function kill_button_cb(){
                console.log("Killing all drones now")

                // POST on server
                const url='http://victor.scapp.io/param/drone_start';
                const data={'kill': 1, 'bool_drone1_start': 666, 'bool_drone2_start': 666, 'bool_drone3_start': 666}
                axios({method: 'POST', url: url, data: data})
            }

            // callback for unkillswitch button
            function unkill_button_cb(){
                console.log("Unkilling all drones now!")

                // POST on server
                const url='http://victor.scapp.io/param/drone_start';
                const data={'kill': 0, 'bool_drone1_start': drone1_start, 'bool_drone2_start': drone2_start, 'bool_drone3_start': drone3_start}
                axios({method: 'POST', url: url, data: data})
            }

            // callback for takeoff button
            function takeoff_button_cb() {
                console.log("Setting drone start state to desired values")

                // POST on server
                const url='http://victor.scapp.io/param/drone_start';
                const data={'kill': 0, 'bool_drone1_start': drone1_start, 'bool_drone2_start': drone2_start, 'bool_drone3_start': drone3_start}
                axios({method: 'POST', url: url, data: data})
            }

            // creates a map object
            function initMap() {

                // define the map itself
                var map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: lat_start, lng: lng_start},
                    zoom: 16,
                    styles: [{
                        featureType: 'poi',
                        stylers: [{ visibility: 'off' }]  // Turn off POI.
                    },
                    {
                        featureType: 'transit.station',
                        stylers: [{ visibility: 'off' }]  // Turn off bus, train stations...
                    }],
                    disableDoubleClickZoom: false,
                    streetViewControl: false,
                });

                // create div for centering button
                var centerControlDiv = document.createElement('div');
                var centerControl = new center_control(centerControlDiv, map);
                centerControlDiv.index = 1;
                map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv);
      
                // create div for centering button
                var centerControlDiv2 = document.createElement('div');
                var centerControl2 = new center_control2(centerControlDiv2, map);
                centerControlDiv2.index = 1;
                map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv2);
      
                // custom markers icons
                var droneR_icon = {
                    url: 'marker/droneR.png',
                    anchor: new google.maps.Point(13, 13),
                    scaledSize: new google.maps.Size(25, 25)
                };
                var droneG_icon = {
                    url: 'marker/droneG.png',
                    anchor: new google.maps.Point(13, 13),
                    scaledSize: new google.maps.Size(25, 25)
                };
                var droneB_icon = {
                    url: 'marker/droneB.png',
                    anchor: new google.maps.Point(13, 13),
                    scaledSize: new google.maps.Size(25, 25)
                };
                var home_icon = {
                    url: 'marker/home.png',
                    anchor: new google.maps.Point(13, 13),
                    scaledSize: new google.maps.Size(25, 25)
                };

                // markers
                var droneR_marker = new google.maps.Marker({
                    map: map,
                    icon: droneR_icon,
                    title: 'Drone'
                });
                var droneG_marker = new google.maps.Marker({
                    map: map,
                    icon: droneG_icon,
                    title: 'Drone'
                });
                var droneB_marker = new google.maps.Marker({
                    map: map,
                    icon: droneB_icon,
                    title: 'Drone'
                });
                var home_marker = new google.maps.Marker({
                    map: map,
                    icon: home_icon,
                    title: 'Home'
                });
                var network_marker = new google.maps.Marker({
                    map: map,
                    icon: 'marker/network.png',
                    title: 'Network estimate',
                });
                var est_marker1 = new google.maps.Marker({
                    map: map,
                    icon: 'marker/estimate2.png',
                    title: 'First estimation',
                });
                var est_marker2 = new google.maps.Marker({
                    map: map,
                    icon: 'marker/estimate.png',
                    title: 'Second estimation',
                });
                var waypointR_marker_list = [];
                var waypointG_marker_list = [];
                var waypointB_marker_list = [];

                // circles
                var network_circle1 = new google.maps.Circle({
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.5,
                    strokeWeight: 2,
                    fillColor: '#FF0000',
                    fillOpacity: 0.1,
                    //editable: true
                })
                var network_circle2 = new google.maps.Circle({
                    strokeColor: '#FFBB00',
                    strokeOpacity: 0.5,
                    strokeWeight: 2,
                    fillColor: '#FF9900',
                    fillOpacity: 0.2,
                    //editable: true
                })
                var network_circle3 = new google.maps.Circle({
                    strokeColor: '#00FF00',
                    strokeOpacity: 0.5,
                    strokeWeight: 2,
                    fillColor: '#00FF00',
                    fillOpacity: 0.1,
                    //editable: true
                })

                // flight path
                var flight_pathR = new google.maps.Polyline({
                    map: map,
                    geodesic: true,
                    strokeColor: '#DD0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 3
                });
                var pathR = [];
                var flight_pathG = new google.maps.Polyline({
                    map: map,
                    geodesic: true,
                    strokeColor: '#00CC00',
                    strokeOpacity: 1.0,
                    strokeWeight: 3
                });
                var pathG = [];
                var flight_pathB = new google.maps.Polyline({
                    map: map,
                    geodesic: true,
                    strokeColor: '#0000DD',
                    strokeOpacity: 1.0,
                    strokeWeight: 3
                });
                var pathB = [];

                // listener for clicks
                map.addListener('click', function(e) {
                    var lat = e.latLng.lat();
                    var lng = e.latLng.lng();

                    // post network estimate on server
                    const url='http://victor.scapp.io/lora/network_estimate_latlng';
                    const data={'lat': lat, 'lng': lng}
                    axios({method: 'POST', url: url, data: data})
                });
                
                // legend
                initLegend(map);

                // start Firebase and database listeners
                initFirebase(map, droneR_marker, droneG_marker, droneB_marker, home_marker, flight_pathR, pathR, flight_pathG, pathG, flight_pathB, pathB, network_marker, est_marker1, est_marker2, waypointR_marker_list, waypointG_marker_list, waypointB_marker_list, network_circle1, network_circle2, network_circle3);
            }

            // init legend
            function initLegend(map){
                // create legend object
                var legend = document.getElementById('legend');

                // add home
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/home.png width=20> Home'
                legend.appendChild(div);

                // add droneR
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/droneR.png width=20> Drone 1'
                legend.appendChild(div);

                // add droneG
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/droneG.png width=20> Drone 2'
                legend.appendChild(div);

                // add droneB
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/droneB.png width=20> Drone 3'
                legend.appendChild(div);

                // add waypoint past
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/waypointR_old_circle.png width=20> Drone 1 past waypoint'
                legend.appendChild(div);

                // add waypoint current
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/waypointR_current_circle.png width=20> Drone 1 current waypoint'
                legend.appendChild(div);

                // add waypoint past
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/waypointG_old_circle.png width=20> Drone 2 past waypoint'
                legend.appendChild(div);

                // add waypoint current
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/waypointG_current_circle.png width=20> Drone 2 current waypoint'
                legend.appendChild(div);

                // add waypoint past
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/waypointB_old_circle.png width=20> Drone 3 past waypoint'
                legend.appendChild(div);

                // add waypoint current
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/waypointB_current_circle.png width=20> Drone 3 current waypoint'
                legend.appendChild(div);

                // add network
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/network_circle.png width=20> Network estimate'
                legend.appendChild(div);

                // add est1
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/estimate2_circle.png width=20> First estimation'
                legend.appendChild(div);

                // add est2
                var div = document.createElement('div');
                div.innerHTML = '<img src=marker/estimate_circle.png width=20> Second estimation'
                legend.appendChild(div);

                // push on map
                map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);
            }

            // init Firebase and set listeners
            function initFirebase(map, droneR_marker, droneG_marker, droneB_marker, home_marker, flight_pathR, pathR, flight_pathG, pathG, flight_pathB, pathB, network_marker, est_marker1, est_marker2, waypointR_marker_list, waypointG_marker_list, waypointB_marker_list, network_circle1, network_circle2, network_circle3) {

                // reference in Firebase
                var drone_refR = firebase.child('droneR');
                var drone_refG = firebase.child('droneG');
                var drone_refB = firebase.child('droneB');
                var home_ref   = firebase.child('home');
                var netw_ref   = firebase.child('network');
                var est_ref    = firebase.child('estimate');
                var wayp_refR  = firebase.child('waypointR');
                var wayp_refG  = firebase.child('waypointG');
                var wayp_refB  = firebase.child('waypointB');

                // for droneR
                drone_refR.on('child_added', function(snapshot) {

                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // move marker
                    droneR_marker.setPosition(new google.maps.LatLng(lat, lng));
                    droneR_marker.setMap(map);

                    // draw path
                    pathR.push({lat: lat, lng: lng});
                    flight_pathR.setPath(pathR);
                    flight_pathR.setMap(map)
                });
                drone_refR.on('child_removed', function(snapshot) {
                    droneR_marker.setMap(null)
                    flight_pathR.setMap(null)
                    pathR = []
                });

                // for droneG
                drone_refG.on('child_added', function(snapshot) {

                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // move marker
                    droneG_marker.setPosition(new google.maps.LatLng(lat, lng));
                    droneG_marker.setMap(map);

                    // draw path
                    pathG.push({lat: lat, lng: lng});
                    flight_pathG.setPath(pathG);
                    flight_pathG.setMap(map)
                });
                drone_refG.on('child_removed', function(snapshot) {
                    droneG_marker.setMap(null)
                    flight_pathG.setMap(null)
                    pathG = []
                });

                // for droneB
                drone_refB.on('child_added', function(snapshot) {

                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // move marker
                    droneB_marker.setPosition(new google.maps.LatLng(lat, lng));
                    droneB_marker.setMap(map);

                    // draw path
                    pathB.push({lat: lat, lng: lng});
                    flight_pathB.setPath(pathB);
                    flight_pathB.setMap(map)
                });
                drone_refB.on('child_removed', function(snapshot) {
                    droneB_marker.setMap(null)
                    flight_pathB.setMap(null)
                    pathB = []
                });

                // for home
                home_ref.on('child_added', function(snapshot){

                    // get coordinates
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // move marker
                    home_marker.setPosition(new google.maps.LatLng(lat, lng));
                    home_marker.setMap(map);

                    // set start as home
                    lat_start = lat;
                    lng_start = lng;
                });
                home_ref.on('child_removed', function(snapshot) {
                    home_marker.setMap(null)
                });

                // for network points
                netw_ref.on('child_added', function(snapshot) {

                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // move marker
                    network_marker.setPosition(new google.maps.LatLng(lat, lng));
                    network_marker.setMap(map);
                });
                netw_ref.on('child_removed', function(snapshot) {
                    //network_marker.setMap(null)
                });

                // for new estimation
                est_ref.on('child_added', function(snapshot) {
                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;
                    var rad = snapshot.val().radius;

                    // different colors based on radius
                    if(rad==150) {
                        network_circle1.setCenter(new google.maps.LatLng(lat, lng));
                        network_circle1.setMap(map);
                        network_circle1.setRadius(rad);
                        network_marker.setPosition(new google.maps.LatLng(lat, lng));
                        network_marker.setMap(map);
                    }
                    if(rad==25) {
                        network_circle2.setCenter(new google.maps.LatLng(lat, lng));
                        network_circle2.setMap(map);
                        network_circle2.setRadius(rad);
                        est_marker1.setPosition(new google.maps.LatLng(lat, lng));
                        est_marker1.setMap(map);
                    }
                    if(rad==10) {
                        network_circle3.setCenter(new google.maps.LatLng(lat, lng));
                        network_circle3.setMap(map);
                        network_circle3.setRadius(rad);
                        est_marker2.setPosition(new google.maps.LatLng(lat, lng));
                        est_marker2.setMap(map);
                    }
                });
                est_ref.on('child_removed', function(snapshot) {
                    network_circle1.setMap(null);
                    network_circle2.setMap(null);
                    network_circle3.setMap(null);
                    est_marker1.setMap(null);
                    est_marker2.setMap(null);
                });

                // for waypoint R
                wayp_refR.on('child_added', function(snapshot) {
                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // change color of last waypoints
                    waypointR_marker_list.forEach(function(item, index, array){
                        item.setIcon('marker/waypointR_old.png');
                    });

                    // create new marker
                    var waypoint_marker = new google.maps.Marker({
                        position: {lat: lat, lng: lng},
                        map: map,
                        icon: 'marker/waypointR_current.png',
                        title: 'Waypoint',
                    });

                    // add it to list
                    waypointR_marker_list.push(waypoint_marker);
                });
                wayp_refR.on('child_removed', function(snapshot) {
                    waypointR_marker_list.forEach(function(item, index, array){
                        item.setMap(null)
                    });  
                });

                // for waypoint G
                wayp_refG.on('child_added', function(snapshot) {
                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // change color of last waypoints
                    waypointG_marker_list.forEach(function(item, index, array){
                        item.setIcon('marker/waypointG_old.png');
                    });

                    // create new marker
                    var waypoint_marker = new google.maps.Marker({
                        position: {lat: lat, lng: lng},
                        map: map,
                        icon: 'marker/waypointG_current.png',
                        title: 'Waypoint',
                    });

                    // add it to list
                    waypointG_marker_list.push(waypoint_marker);
                });
                wayp_refG.on('child_removed', function(snapshot) {
                    waypointG_marker_list.forEach(function(item, index, array){
                        item.setMap(null)
                    });  
                });

                // for waypoint B
                wayp_refB.on('child_added', function(snapshot) {
                    // get coordinates from firebase
                    var lat = snapshot.val().lat;
                    var lng = snapshot.val().lng;

                    // change color of last waypoints
                    waypointB_marker_list.forEach(function(item, index, array){
                        item.setIcon('marker/waypointB_current.png');
                    });

                    // create new marker
                    var waypoint_marker = new google.maps.Marker({
                        position: {lat: lat, lng: lng},
                        map: map,
                        icon: 'marker/waypointB_old.png',
                        title: 'Waypoint',
                    });

                    // add it to list
                    waypointB_marker_list.push(waypoint_marker);
                });
                wayp_refB.on('child_removed', function(snapshot) {
                    waypointB_marker_list.forEach(function(item, index, array){
                        item.setMap(null)
                    });  
                });


            }   

        </script>
        <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxXZYRRheu8t7VGerySo98OVrOxjdcZe8&libraries=visualization&callback=initMap">
        </script>
    </body>
</html>